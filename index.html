<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Teachable Machine Pong</title>
  <style>
    body {
      margin: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh;
      background: #000;
      color: #fff;
      font-family: Arial, sans-serif;
      gap: 8px;
      padding: 12px;
    }
    canvas { border: 2px solid #fff; background: #000; }
    #controls { display:flex; gap:8px; align-items:center; }
    button { padding:8px 12px; cursor:pointer; }
    #label-container { width: 800px; max-width: 95vw; text-align:left; }
    .label-row { font-size:14px; padding:2px 0; }
    .detected { font-weight:700; color: #0f0; }
    .info { font-size:13px; color:#ccc; margin-bottom:6px; }
  </style>
</head>
<body>

  <h2>Pong</h2>
  <div id="controls">
    <button id="toggleBtn">Start Recognizer</button>
    <div class="info">Snap -> Down </br> Hit -> Up</div>
  </div>
  <div id="label-container"></div>
  <canvas id="pong" width="800" height="440"></canvas>

  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/speech-commands@0.4.0/dist/speech-commands.min.js"></script>

<script>
const canvas = document.getElementById('pong');
const ctx = canvas.getContext('2d');

const paddleWidth = 10, paddleHeight = 200;
const ballSize = 10;

let ballX = canvas.width/2, ballY = canvas.height/2;
let ballSpeedX = 3, ballSpeedY = 3;

let paddleY = canvas.height/2 - paddleHeight/2;
let paddleSpeed = 6;

const commandHoldMs = 300;
let lastCommand = '';
let lastCommandTime = 0;

function drawBall(){ ctx.fillStyle='white'; ctx.fillRect(ballX, ballY, ballSize, ballSize); }
function drawPaddle(){ ctx.fillStyle='white'; ctx.fillRect(0, paddleY, paddleWidth, paddleHeight); }

function updateBall(){
  ballX += ballSpeedX; ballY += ballSpeedY;
  if (ballY + ballSize > canvas.height || ballY < 0) ballSpeedY = -ballSpeedY;
  if (ballX + ballSize > canvas.width) ballSpeedX = -ballSpeedX;
  if (ballX < paddleWidth && ballY + ballSize > paddleY && ballY < paddleY + paddleHeight){
    ballSpeedX = -ballSpeedX;
  }
  if (ballX < 0) resetBall();
}

function resetBall(){
  ballX = canvas.width/2; ballY = canvas.height/2;
  ballSpeedX = 3; ballSpeedY = 3;
}

function movePaddle(){
  const now = Date.now();
  if (now - lastCommandTime < commandHoldMs){
    if (lastCommand === 'up' && paddleY > 0){
      paddleY -= paddleSpeed;
      if (paddleY < 0) paddleY = 0;
    } else if (lastCommand === 'down' && paddleY + paddleHeight < canvas.height){
      paddleY += paddleSpeed;
      if (paddleY + paddleHeight > canvas.height) paddleY = canvas.height - paddleHeight;
    }
  }
}

function drawLastCommand(){
  ctx.fillStyle = 'white';
  ctx.font = '16px Arial';
  ctx.fillText('Last command: ' + (lastCommand || 'none'), 20, 20);
}

function gameLoop(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  drawBall(); drawPaddle(); updateBall(); movePaddle(); drawLastCommand();
  requestAnimationFrame(gameLoop);
}
gameLoop();

const MODEL_URL_BASE = "https://teachablemachine.withgoogle.com/models/5n0JDzpafu/"; 

let recognizer = null;
let listening = false;
const labelContainer = document.getElementById('label-container');
const toggleBtn = document.getElementById('toggleBtn');

function safeLog(...args){ console.log('[TM-Pong]', ...args); }

async function createRecognizer(){
  const checkpointURL = MODEL_URL_BASE + 'model.json';
  const metadataURL   = MODEL_URL_BASE + 'metadata.json';
  safeLog('Loading model from:', checkpointURL, metadataURL);

  const r = speechCommands.create('BROWSER_FFT', undefined, checkpointURL, metadataURL);
  await r.ensureModelLoaded();
  safeLog('Model loaded. Labels:', r.wordLabels());
  return r;
}

function renderLabels(labels, scores, highlightIndex){
  labelContainer.innerHTML = '';
  for(let i=0;i<labels.length;i++){
    const row = document.createElement('div');
    row.className = 'label-row' + (i===highlightIndex? ' detected' : '');
    row.innerText = labels[i] + ': ' + (scores && scores[i] !== undefined ? scores[i].toFixed(3) : '0.000');
    labelContainer.appendChild(row);
  }
}

function argMax(array){
  let maxI = 0;
  for(let i=1;i<array.length;i++){
    if (array[i] > array[maxI]) maxI = i;
  }
  return maxI;
}

async function startListening(){
  if (!recognizer){
    try {
      recognizer = await createRecognizer();
    } catch(err){
      return;
    }
  }

  if (listening) return;
  renderLabels(recognizer.wordLabels(), null, -1);

  recognizer.listen(result => {
    const scores = Array.from(result.scores);
    const labels = recognizer.wordLabels();
    const maxIndex = argMax(scores);
    const commandRaw = labels[maxIndex];
    const scoreMax = scores[maxIndex];

    safeLog('scores:', scores.map(s => s.toFixed(3)));
    safeLog('labels:', labels);
    safeLog('detected:', commandRaw, 'score:', scoreMax.toFixed(3));

    renderLabels(labels, scores, maxIndex);

    const cmd = (commandRaw || '').toLowerCase();
    if (scoreMax < 0.30) {
      lastCommand = '';
    } else if (cmd.includes('up')) {
      lastCommand = 'up';
      lastCommandTime = Date.now();
    } else if (cmd.includes('down')) {
      lastCommand = 'down';
      lastCommandTime = Date.now();
    } else if (cmd.includes('background') || cmd.includes('noise') || cmd.includes('unknown') || cmd.includes('silence')) {
      lastCommand = '';
    } else {
      lastCommand = '';
    }

  }, {
    includeSpectrogram: false,
    probabilityThreshold: 0.6,
    invokeCallbackOnNoiseAndUnknown: true,
    overlapFactor: 0.0
  });

  listening = true;
  toggleBtn.textContent = 'Stop Recognizer';
}

function stopListening(){
  if (recognizer && listening){
    recognizer.stopListening();
    listening = false;
    toggleBtn.textContent = 'Start Recognizer';
    safeLog('Stopped listening.');
  }
}

toggleBtn.addEventListener('click', async () => {
  if (!listening) {
    await startListening();
  } else {
    stopListening();
  }
});
</script>

</body>
</html>

